<?php&#10&#10namespace Drupal\votacao\Controller;&#10&#10use Drupal\Core\Controller\ControllerBase;&#10use Drupal\votacao\Entity\OpcaoResposta;&#10use Drupal\votacao\Entity\Pergunta;&#10use Symfony\Component\HttpFoundation\RedirectResponse;&#10use Symfony\Component\HttpFoundation\Request;&#10&#10class VotacaoController extends ControllerBase {&#10&#10  public function exibirPergunta(Pergunta $pergunta) {&#10    $opcoes = $pergunta->get('opcoes')->referencedEntities();&#10&#10    $build = [&#10      '#theme' => 'votacao_form',&#10      '#pergunta' => $pergunta,&#10      '#opcoes' => $opcoes,&#10      '#cache' => ['max-age' => 0],&#10    ];&#10&#10    return $build;&#10  }&#10&#10  public function registrarVoto(Request $request, Pergunta $pergunta) {&#10    $opcao_id = $request->get('opcao');&#10    $opcao = OpcaoResposta::load($opcao_id);&#10&#10    if ($opcao && in_array($opcao_id, array_map(fn($o) => $o->id(), $pergunta->get('opcoes')&#10        ->referencedEntities()))) {&#10      $votos_atuais = $opcao->get('votos')->value;&#10      $opcao->set('votos', $votos_atuais + 1);&#10      $opcao->save();&#10&#10      $this->messenger()&#10        ->addStatus($this->t('Seu voto foi registrado com sucesso.'));&#10    }&#10    else {&#10      $this->messenger()->addError($this->t('OpÃ§Ã£o invÃ¡lida.'));&#10    }&#10&#10    return new RedirectResponse('/votacao/' . $pergunta->id());&#10  }&#10&#10}&#10